---

- name: Create Zsh config directory and target file
  vars:
    is_template: "{{ misc_create_zshconf_src is defined and (misc_create_zshconf_src | regex_search('\\.j2$')) }}"
  block:
    - name: Create conf directory
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.config/zsh"
        state: directory
        mode: '0755'

    - name: Copy config file
      when:
        - not ansible_check_mode
        - misc_create_zshconf_src is defined
        - misc_create_zshconf_cmd is undefined
        - not (is_template)
      ansible.builtin.copy:
        src: "{{ misc_create_zshconf_src }}"
        dest: "{{ ansible_env.HOME }}/.config/zsh/{{ misc_create_zshconf_src }}"
        mode: '0644'

    - name: Create config file with cmd
      when:
        - not ansible_check_mode
        - misc_create_zshconf_cmd is defined
        - misc_create_zshconf_src is defined
        - not (is_template)
      ansible.builtin.shell:
        cmd: |
          {{ misc_create_zshconf_cmd }} > {{ ansible_env.HOME }}/.config/zsh/{{ misc_create_zshconf_src }}
      changed_when: false

    - name: Create config file with template
      when:
        - not ansible_check_mode
        - misc_create_zshconf_src is defined
        - misc_create_zshconf_cmd is undefined
        - is_template
      ansible.builtin.template:
        src: "{{ misc_create_zshconf_src }}"
        dest: "{{ ansible_env.HOME }}/.config/zsh/{{ misc_create_zshconf_src | regex_replace('\\.j2$', '') }}"
        mode: '0644'
