name: CI

on:
  push:
    branches: [main]
  pull_request_target:
    branches: [main]
  workflow_dispatch:

jobs:
  execute:
    needs: [setup]
    runs-on: macos-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with: 
        ref: ${{ github.head_ref }}

    - name: Set up Homebrew
      uses: Homebrew/actions/setup-homebrew@master

    - name: Check ansible installed
      id: check-ansible
      run: |
        if which ansible > /dev/null; then
          echo "ansible has already installed"
          echo "installed=true" >> $GITHUB_OUTPUT
        else
          echo "ansible is not installed"
          echo "installed=false" >> $GITHUB_OUTPUT
        fi

    - name: Install ansible
      if: ${{ !steps.check-ansible.outputs.installed || github.event_name == 'pull_request_target' }}
      run: brew install ansible

    - name: Set ansible mode
      id: set-mode
      run: |
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "execute with check mode"
            echo "options=--check" >> $GITHUB_OUTPUT
          else
            echo "execute with normal mode"
            echo "options=" >> $GITHUB_OUTPUT
          fi

    - name: Run playbook
      uses: dawidd6/action-ansible-playbook@v2
      with:
        playbook: site.yml
        options: ${{ steps.set-mode.outputs.options }}
